<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mood Garden</title>

<style>
:root {
  --bg: #07070a;
  --fg: #eaeaea;
  --muted: rgba(234,234,234,.65);
  --panel: rgba(10,10,14,.72);
  --panelBorder: rgba(234,234,234,.14);
}
html,body {
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--fg);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  overflow:hidden;
}

/* Canvas */
#cosmos {
  position:fixed; inset:0;
  width:100vw; height:100vh;
}

/* HUD */
#hud {
  position:fixed; top:16px; left:16px; z-index:5;
  user-select:none; pointer-events:none;
}
#hud .title {
  font-size:13px; letter-spacing:.08em; text-transform:uppercase;
}
#hud .sub {
  margin-top:6px; font-size:12px; color:var(--muted);
  max-width:320px; line-height:1.3;
}

/* Spotify progress bar */
#spotifyProgress {
  width:160px;
  height:5px;
  border-radius:999px;
  background:rgba(255,255,255,0.12);
  overflow:hidden;
  margin-top:6px;
  transition:opacity .3s ease;
  opacity:0;
}
#spotifyProgress.show {opacity:1;}
#spotifyProgressInner {
  width:0%; height:100%;
  background:rgba(255,255,255,0.85);
  border-radius:inherit;
  transition:width .25s ease;
}

/* CTA */
#ctaWrap {
  position:fixed; inset:0;
  display:grid; place-items:center;
  z-index:6;
}
#cta {
  pointer-events:auto;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
  color:var(--fg);
  padding:14px 18px;
  border-radius:999px;
  font-size:14px;
  letter-spacing:.02em;
  cursor:pointer;
  backdrop-filter:blur(10px);
  transition:.15s;
}
#cta:hover {
  background:rgba(255,255,255,.1);
}
#ctaWrap.hidden {opacity:0;pointer-events:none;}

/* Album overlay */
#albumsOverlay {
  display:none;
  position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px);
  z-index:30;
  display:grid; place-items:center;
}
#albumsPanel {
  background:var(--panel);
  border:1px solid var(--panelBorder);
  border-radius:18px;
  width:min(680px,90vw);
  max-height:80vh;
  overflow:auto;
  padding:20px;
}
.btn {
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.2);
  color:var(--fg);
  padding:6px 12px;
  border-radius:12px;
  cursor:pointer;
}
.btn.secondary {
  background:transparent;
  color:var(--muted);
  border-color:rgba(255,255,255,.15);
}
</style>
</head>

<body>
<canvas id="cosmos"></canvas>

<div id="hud">
  <div class="title">Mood Garden</div>
  <div class="sub" id="hudSub">You are observing the cosmos.</div>
  <div id="spotifyProgress"><div id="spotifyProgressInner"></div></div>
  <button id="showAlbums" class="btn" style="margin-top:10px;pointer-events:auto;">View Albums</button>
</div>

<div id="ctaWrap">
  <button id="cta">Connect Spotify</button>
</div>

<!-- Album viewer overlay -->
<div id="albumsOverlay">
  <div id="albumsPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Your Albums</h2>
      <button id="closeAlbums" class="btn secondary">Close</button>
    </div>
    <ul id="albumsList" style="margin-top:16px;list-style:none;padding:0;font-size:14px;color:var(--muted);line-height:1.5;"></ul>
  </div>
</div>

<script>
/* Storage helpers */
const KEY_ME="mg_v1_me",KEY_UNIVERSE="mg_v1_universe";
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}
function loadJSON(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v));}
function loadMe(){return loadJSON(KEY_ME,null);}
function saveMe(v){saveJSON(KEY_ME,v);}
function saveUniverse(v){saveJSON(KEY_UNIVERSE,v);}
function loadUniverse(){return loadJSON(KEY_UNIVERSE,[]);}

/* Basic HUD */
const hudSub=document.getElementById("hudSub");
const cta=document.getElementById("cta");
cta.onclick=()=>connectSpotify();

function connectSpotify(){
  const SPOTIFY_CLIENT_ID="ac1de2951cfa471a8c05dc6ef4b56ad4";
  const SPOTIFY_REDIRECT_URI="https://mood-garden-alpha.vercel.app/";
  const AUTH_URL=`https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(SPOTIFY_REDIRECT_URI)}&scope=user-library-read`;
  window.location.href=AUTH_URL;
}

/* Spotify import with progress bar */
window.addEventListener("load",async()=>{
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  if(!code)return;

  const progressBar=document.getElementById("spotifyProgress");
  const progressInner=document.getElementById("spotifyProgressInner");
  progressBar.classList.add("show");
  hudSub.textContent="Connecting to Spotify...";

  try{
    const res=await fetch(`/api/spotify-auth?code=${code}`);
    const data=await res.json();
    console.log("Spotify data:",data);

    if(!data.albums||!data.albums.length){
      hudSub.textContent="No albums found in your Spotify library.";
      progressBar.classList.remove("show");
      return;
    }

    const total=data.albums.length;
    let loaded=0;
    const me={id:uid(),name:data.user,albums:[]};

    for(const album of data.albums){
      me.albums.push(album.toLowerCase());
      loaded++;
      const pct=Math.round((loaded/total)*100);
      progressInner.style.width=pct+"%";
      if(loaded%10===0)await new Promise(r=>setTimeout(r,10));
    }

    saveMe(me);
    saveUniverse([me]);
    progressInner.style.width="100%";
    hudSub.textContent=`Imported ${total} albums from Spotify!`;
    setTimeout(()=>{
      progressBar.classList.remove("show");
      window.history.replaceState({},document.title,window.location.pathname);
      location.reload();
    },1200);

  }catch(err){
    console.error("Spotify import error:",err);
    hudSub.textContent="Spotify import failed (network).";
    progressBar.classList.remove("show");
  }
});

/* Album viewer */
document.getElementById("showAlbums").addEventListener("click",()=>{
  const me=loadMe();
  const list=document.getElementById("albumsList");
  const overlay=document.getElementById("albumsOverlay");
  if(!me?.albums?.length){
    list.innerHTML="<li>No albums imported yet.</li>";
  }else{
    list.innerHTML=me.albums.map(a=>`<li>${a}</li>`).join("");
  }
  overlay.style.display="grid";
});
document.getElementById("closeAlbums").addEventListener("click",()=>{
  document.getElementById("albumsOverlay").style.display="none";
});

/* Simple background for now */
const canvas=document.getElementById("cosmos");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;draw();}
window.addEventListener("resize",resize);
function draw(){
  ctx.fillStyle=varBg();ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<120;i++){
    ctx.fillStyle="rgba(255,255,255,"+(0.2+Math.random()*0.6)+")";
    ctx.beginPath();
    ctx.arc(Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*1.5,0,Math.PI*2);
    ctx.fill();
  }
}
function varBg(){return getComputedStyle(document.documentElement).getPropertyValue("--bg");}
resize();
</script>
</body>
</html>
